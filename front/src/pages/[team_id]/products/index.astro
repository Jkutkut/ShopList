---
import teamService, { client as teamServiceClient } from "../../../api/versions/v1/teamService";
import productService, { client as productServiceClient } from "../../../api/versions/v1/productService";
import Page from "../../../layouts/page.astro";
import { OPTIONS, PRODUCTS } from "../../../mockup";
import { previousPageUrl } from "../../../utils";
import type { Product } from "../../../types";
import ProductManager from "../../../components/product/ProductManager";
import "../../../styles/product.css"

const { team_id } = Astro.params;

if (!team_id) {
  return Astro.redirect('/teams', 302);
}

teamServiceClient.addToken(Astro.cookies.get("jwt")!.value);
const result = await teamService.getTeam(team_id);
if (result.isErr()) {
  console.error("Unable to get team:", result.unwrapErr());
  return Astro.redirect("/teams");
}

const team = result.unwrap().data;
const teamName = team.display_name || team.name;

productServiceClient.addToken(Astro.cookies.get("jwt")!.value);
const productsResult = await productService.getProducts(team_id);

if (productsResult.isErr()) {
  console.error("Unable to get products:", productsResult.unwrapErr());
}
const productsArr: Product[] = productsResult.isOk() ? productsResult.unwrap().data : [];
const products = productsArr.sort((a, b) => a.name.localeCompare(b.name));
---

<Page
  title={`${teamName}'s products`}
  description=`Manage the products of the team ${teamName}`
  options={[
    { name: 'Back', url: previousPageUrl(Astro) },
    ...OPTIONS['products']
  ]}
  icon={team.image}
>
  <section>
    <h1>Products of {teamName}</h1>
    <ProductManager client:only
      team={team}
      products={products}
    />
  </section>
</Page>
