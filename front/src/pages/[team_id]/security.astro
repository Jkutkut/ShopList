---
import teamService, { client as teamServiceClient } from "../../api/versions/v1/teamService";
import userService, { client as userServiceClient } from "../../api/versions/v1/userService";
import MembersAdministration from "../../components/config/MembersAdministration";
import Page from "../../layouts/page.astro";
import { OPTIONS } from "../../mockup";
import { previousPageUrl } from "../../utils";

const { team_id } = Astro.params;

if (!team_id) {
  return Astro.redirect('/teams', 302);
}

teamServiceClient.addToken(Astro.cookies.get("jwt")!.value);

const teamResult = await teamService.getTeam(team_id);
if (teamResult.isErr()) {
  console.error("Unable to get team:", teamResult.unwrapErr());
  return Astro.redirect("/teams");
}

const team = teamResult.unwrap().data;

userServiceClient.addToken(Astro.cookies.get("jwt")!.value);
const [
  meResult,
  teamMembersResult
] = await Promise.all([
  userService.me(),
  teamService.teamMembers(team.id)
]);

if (meResult.isErr()) {
  console.error("Unable to get user info:", meResult.unwrapErr());
  return Astro.redirect("/teams");
}
if (teamMembersResult.isErr()) {
  console.error("Unable to get team members:", teamMembersResult.unwrapErr());
  return Astro.redirect("/teams");
}

const user = meResult.unwrap().data;
const teamRoles = teamMembersResult.unwrap().data;

const teamName = team.display_name || team.name;
---
<Page
  title=`Shoplist - ${teamName} security`
  description=`Manage users within ${teamName}`
  options={[
    { name: 'Back', url: previousPageUrl(Astro) },
    ...OPTIONS['security-team']
  ]}
>
  <section class="col gap">
    <h1>Members of {teamName}</h1>
    <MembersAdministration
      team={team}
      teamRoles={teamRoles}
      user={user}
      client:only
    />
  </section>
</Page>
